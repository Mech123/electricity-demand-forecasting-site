<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SARIMA – Model</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="../assets/style.css" />

  <style>
    .tabs { display:flex; flex-wrap:wrap; gap:8px; margin: 8px 0 0; }
    .tab {
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border:1px solid var(--border); border-radius: 999px;
      text-decoration:none; color: var(--text-main); background:#fff;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .tab:hover{ transform: translateY(-1px); box-shadow: 0 8px 20px rgba(16,24,40,.08); }
    .tab.active { background: var(--primary); border-color: var(--primary); color:#fff; }

    .summary-box{
      border:1px solid var(--border);
      border-radius: 12px;
      background:#fff;
      padding: 12px;
      margin-top: 12px;
    }

    .metrics { width:100%; border-collapse: collapse; margin-top: 10px; border:1px solid var(--border); border-radius: 10px; overflow:hidden; }
    .metrics th, .metrics td { padding: 10px 12px; border-bottom:1px solid var(--border); text-align:left; }
    .metrics th { background:#f9fafb; }
    .metrics tr:last-child td { border-bottom:none; }

    .gallery { display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:14px; margin-top: 12px; }
    @media (max-width: 980px){ .gallery { grid-template-columns: 1fr; } }
    .figure { border:1px solid var(--border); border-radius: 10px; overflow:hidden; background:#fff; }
    .figure img { width:100%; height:auto; display:block; cursor: zoom-in; }
    .figcap { padding: 10px 12px; border-top:1px solid var(--border); }
    .figcap .title { margin:0 0 6px 0; font-weight:700; }
    .figcap .desc { margin:0; color: var(--text-muted); }

    /* modal */
    .img-modal{ position:fixed; inset:0; background: rgba(0,0,0,.72); display:none; align-items:center; justify-content:center; padding: 22px; z-index: 9999; }
    .img-modal.open{ display:flex; }
    .img-modal-card{ max-width: min(1100px, 96vw); max-height: 92vh; width: 100%; background:#111827; border-radius: 14px; overflow:hidden; border: 1px solid rgba(255,255,255,.12); box-shadow: 0 24px 80px rgba(0,0,0,.45); }
    .img-modal-top{ display:flex; align-items:center; justify-content:space-between; padding: 10px 12px; color:#e5e7eb; gap:12px; border-bottom: 1px solid rgba(255,255,255,.10); }
    .img-modal-top .cap{ font-size: 13px; color: #d1d5db; }
    .img-modal-top button{ border:1px solid rgba(255,255,255,.18); background: transparent; color:#fff; border-radius: 10px; padding: 6px 10px; cursor:pointer; }
    .img-modal-body{ background:#0b1220; display:flex; align-items:center; justify-content:center; }
    .img-modal-body img{ max-width: 100%; max-height: 82vh; width:auto; height:auto; display:block; }
  </style>

  <style>
    /* Header Styling */
    .topbar {
      height: 90px;
      overflow: visible;
      background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      border-bottom: 2px solid rgba(0, 120, 255, 0.1);
    }

    .content {
      padding-top: 112px;
    }

    /* Enhanced Header Styling */
    .topbar-center {
      font-size: 2em;
      font-weight: 700;
      letter-spacing: 3px;
      color: #0078ff;
      background: linear-gradient(135deg, #0078ff 0%, #3b82f6 50%, #6366f1 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      position: relative;
      display: inline-block;
      padding: 8px 24px;
      margin: 0 auto;
      text-transform: uppercase;
      transition: all 0.3s ease;
    }

    .topbar-center::before {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      bottom: 2px;
      height: 3px;
      background: linear-gradient(90deg, transparent, #0078ff, #3b82f6, #0078ff, transparent);
      border-radius: 2px;
      opacity: 0.5;
      animation: shimmer-line 3s ease-in-out infinite;
    }

    @keyframes shimmer-line {
      0%, 100% {
        opacity: 0.3;
      }
      50% {
        opacity: 0.7;
      }
    }

    /* Ensure hamburger button is clickable */
    .icon-btn {
      z-index: 1002;
      position: relative;
    }

    /* Match background to header */
    body {
      background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
    }

    html {
      background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
    }

    /* Logo styling */
    .header-logo {
      height: 150px;
      width: auto;
      margin-right: 1px;
      margin-left: -10px;
      object-fit: contain;
    }
  </style>
</head>

<body>
<header class="topbar">
  <div class="topbar-left">
    <button class="icon-btn" aria-label="Menu"><i class="bi bi-list"></i></button>
    <img src="../assets/images/logo.png" alt="EurGrid Logo" class="header-logo">
  </div>
  <div class="topbar-center">EurGrid</div>
</header>

<aside class="sidebar">
  <div class="sidebar-brand">
    Electricity Demand Forecasting
    <div class="brand-sub">Bathula Veera • Gagan • Pinky Sherwani</div>
  </div>

  <nav class="nav">
    <a class="nav-link" href="../index.html"><i class="bi bi-house-door"></i> Home</a>
    <a class="nav-link" href="problem.html"><i class="bi bi-bullseye"></i> Understanding the Problem</a>
    <a class="nav-link" href="dataset.html"><i class="bi bi-database"></i> Dataset</a>
    <a class="nav-link" href="preprocessing.html"><i class="bi bi-sliders"></i> Pre Processing</a>
    <a class="nav-link" href="eda.html"><i class="bi bi-graph-up"></i> Exploratory Data Analysis</a>
    <a class="nav-link" href="features.html"><i class="bi bi-diagram-3"></i> Feature Engineering</a>
    <a class="nav-link active" href="models.html"><i class="bi bi-cpu"></i> Models & Results</a>
    <a class="nav-link" href="explainability.html"><i class="bi bi-lightbulb"></i> Explainability</a>
    <a class="nav-link" href="references.html"><i class="bi bi-book"></i> References</a>

    <div class="nav-divider"></div>
    <a class="nav-link" id="githubLink"><i class="bi bi-github"></i> Git Repository</a>
  </nav>

  <div style="padding:14px 16px;color:#cfd8e3;">
    © <span id="year"></span>
  </div>
</aside>

<main class="content">
  <section class="card">
    <h1 style="margin:0;">SARIMA</h1>

    <p class="muted" style="margin-top:10px;">
      Statistical baseline capturing trend + seasonality.
    </p>

    <div class="tabs">
      <a class="tab active" href="model_sarima.html"><i class="bi bi-graph-up"></i> SARIMA</a>
      <a class="tab" href="model_lstm.html"><i class="bi bi-cpu"></i> LSTM</a>
      <a class="tab" href="model_hybrid.html"><i class="bi bi-layers"></i> Hybrid</a>
      <a class="tab" href="model_ensemble.html"><i class="bi bi-diagram-2"></i> Ensemble</a>
    </div>

    <div class="hero-actions" style="margin-top:12px;">
      <a class="btn" href="../assets/outputs/sarima/sarima_metrics.json" target="_blank" rel="noopener">
        <i class="bi bi-braces"></i> Open metrics JSON
      </a>
      <a class="btn" href="../assets/outputs/sarima/sarima_forecasts.csv" target="_blank" rel="noopener">
        <i class="bi bi-table"></i> Open forecasts CSV
      </a>
      <a class="btn" href="https://github.com/Mech123/dswp_group2/blob/main/Gagan/sarima_model.ipynb" target="_blank" rel="noopener">
        <i class="bi bi-journal-code"></i> Notebook (GitHub)
      </a>
    </div>

    <!-- Summary FIRST -->
    <div class="summary-box">
      <h2 style="margin:0 0 8px;">Summary</h2>
      <p class="muted" style="margin:0;">
        SARIMA is implemented as a classical baseline for hourly electricity demand forecasting in Germany (2015–2018). The workflow loads the preprocessed time series, enforces a datetime index, and applies a time-based split (train: 2015–2017, test: 2018). Seasonality and stationarity are examined using visual analysis, ADF/KPSS tests, and ACF/PACF plots. Due to computational constraints, automated order search is skipped, and a manually specified SARIMA(1,1,1)(1,1,1,24) configuration is trained on a reduced window for efficiency. The model produces forecasts for 2018, compares predicted and actual demand through plots, analyzes residual behavior, and evaluates performance using standard metrics such as MAE, RMSE, MAPE/sMAPE, bias, and R².
      </p>
    </div>
  </section>

  <!-- Metrics SECOND (from SARIMA forecasts CSV, not eval table) -->
  <section class="card">
    <h2>Metrics</h2>
    <p class="muted">Overall and peak metrics.</p>

    <div id="mState" class="muted">Computing metrics</div>

    <table class="metrics" id="mTable" style="display:none;">
      <thead><tr><th>Metric</th><th>Value</th></tr></thead>
      <tbody id="mBody"></tbody>
    </table>
  </section>

  <!-- Figures THIRD -->
  <section class="card">
    <h2>Figures</h2>
    <p class="muted">Click any image to enlarge.</p>

    <!-- All 11 SARIMA screenshots in order -->
    <div class="gallery">
      <div class="figure">
        <img data-modal="true" data-caption="00_data_shift_analysis.png" src="../assets/images/models/sarima/00_data_shift_analysis.png" alt="00_data_shift_analysis">
        <div class="figcap"><p class="title">00_data_shift_analysis.png</p><p class="desc">Train vs test distribution and drift checks.</p></div>
      </div>

      <div class="figure">
        <img data-modal="true" data-caption="01_time_series_overview.png" src="../assets/images/models/sarima/01_time_series_overview.png" alt="01_time_series_overview">
        <div class="figcap"><p class="title">01_time_series_overview.png</p><p class="desc">Full series with train/test split.</p></div>
      </div>

      <div class="figure">
        <img data-modal="true" data-caption="03_distribution_analysis.png" src="../assets/images/models/sarima/03_distribution_analysis.png" alt="03_distribution_analysis">
        <div class="figcap"><p class="title">03_distribution_analysis.png</p><p class="desc">Load distribution and descriptive statistics.</p></div>
      </div>

      <div class="figure">
        <img data-modal="true" data-caption="04_seasonal_decomposition.png" src="../assets/images/models/sarima/04_seasonal_decomposition.png" alt="04_seasonal_decomposition">
        <div class="figcap"><p class="title">04_seasonal_decomposition.png</p><p class="desc">Trend/seasonal/residual components.</p></div>
      </div>

      <div class="figure">
        <img data-modal="true" data-caption="05_seasonal_patterns.png" src="../assets/images/models/sarima/05_seasonal_patterns.png" alt="05_seasonal_patterns">
        <div class="figcap"><p class="title">05_seasonal_patterns.png</p><p class="desc">Daily and weekly seasonality behaviour.</p></div>
      </div>

      <div class="figure">
        <img data-modal="true" data-caption="06_differencing.png" src="../assets/images/models/sarima/06_differencing.png" alt="06_differencing">
        <div class="figcap"><p class="title">06_differencing.png</p><p class="desc">Stationarity preparation via differencing.</p></div>
      </div>

      <div class="figure">
        <img data-modal="true" data-caption="07_acf_pacf_original.png" src="../assets/images/models/sarima/07_acf_pacf_original.png" alt="07_acf_pacf_original">
        <div class="figcap"><p class="title">07_acf_pacf_original.png</p><p class="desc">Autocorrelation diagnostics for SARIMA orders.</p></div>
      </div>

      <div class="figure">
        <img data-modal="true" data-caption="09_residual_analysis.png" src="../assets/images/models/sarima/09_residual_analysis.png" alt="09_residual_analysis">
        <div class="figcap"><p class="title">09_residual_analysis.png</p><p class="desc">Residual checks.</p></div>
      </div>

      <div class="figure">
        <img data-modal="true" data-caption="10_forecasts.png" src="../assets/images/models/sarima/10_forecasts.png" alt="10_forecasts">
        <div class="figcap"><p class="title">10_forecasts.png</p><p class="desc">Forecast vs actual (full and zoomed).</p></div>
      </div>

      <div class="figure">
        <img data-modal="true" data-caption="11_forecast_scatter.png" src="../assets/images/models/sarima/11_forecast_scatter.png" alt="11_forecast_scatter">
        <div class="figcap"><p class="title">11_forecast_scatter.png</p><p class="desc">Actual vs predicted scatter.</p></div>
      </div>

      <div class="figure">
        <img data-modal="true" data-caption="12_error_analysis.png" src="../assets/images/models/sarima/12_error_analysis.png" alt="12_error_analysis">
        <div class="figcap"><p class="title">12_error_analysis.png</p><p class="desc">Error distribution and peak-specific errors.</p></div>
      </div>
    </div>
  </section>
</main>

<!-- Modal -->
<div class="img-modal" id="imgModal" role="dialog" aria-modal="true" aria-label="Image preview">
  <div class="img-modal-card">
    <div class="img-modal-top">
      <div class="cap" id="imgModalCap">Figure</div>
      <button type="button" id="imgModalClose"><i class="bi bi-x-lg"></i> Close</button>
    </div>
    <div class="img-modal-body">
      <img id="imgModalImg" alt="Expanded figure" />
    </div>
  </div>
</div>

<script>
  function num(x){
    const n = Number(x);
    return Number.isFinite(n) ? n : null;
  }
  function mean(arr){ return arr.reduce((a,b)=>a+b,0)/arr.length; }
  function mae(y, yhat){ let s=0; for (let i=0;i<y.length;i++) s += Math.abs(y[i]-yhat[i]); return s/y.length; }
  function rmse(y, yhat){ let s=0; for (let i=0;i<y.length;i++){ const e=y[i]-yhat[i]; s += e*e; } return Math.sqrt(s/y.length); }
  function mape(y, yhat){
    let s=0, c=0;
    for (let i=0;i<y.length;i++){
      if (y[i] === 0) continue;
      s += Math.abs((y[i]-yhat[i]) / y[i]);
      c++;
    }
    return c ? (s/c)*100 : null;
  }
  function smape(y, yhat){
    let s=0, c=0;
    for (let i=0;i<y.length;i++){
      const denom = (Math.abs(y[i])+Math.abs(yhat[i]));
      if (denom === 0) continue;
      s += 2*Math.abs(y[i]-yhat[i]) / denom;
      c++;
    }
    return c ? (s/c)*100 : null;
  }
  function r2(y, yhat){
    const ybar = mean(y);
    let ssRes=0, ssTot=0;
    for (let i=0;i<y.length;i++){
      const e=y[i]-yhat[i]; ssRes += e*e;
      const d=y[i]-ybar; ssTot += d*d;
    }
    return ssTot === 0 ? null : (1 - (ssRes/ssTot));
  }
  function percentile(arr, p){
    const a = [...arr].sort((x,y)=>x-y);
    const idx = (p/100)*(a.length-1);
    const lo = Math.floor(idx), hi = Math.ceil(idx);
    if (lo === hi) return a[lo];
    const w = idx-lo;
    return a[lo]*(1-w) + a[hi]*w;
  }
  function fmt(n){
    if (n === null || n === undefined || Number.isNaN(n)) return "";
    return n.toLocaleString(undefined, { maximumFractionDigits: 3 });
  }

  // CSV parser that handles commas-less numeric csv (your file)
  function parseCSV(text){
    const lines = text.trim().split(/\r?\n/);
    const header = lines[0].split(",").map(s => s.trim());
    const rows = [];
    for (let i=1; i<lines.length; i++){
      if (!lines[i].trim()) continue;
      const cols = lines[i].split(",").map(s => s.trim());
      const obj = {};
      header.forEach((h, idx) => obj[h] = cols[idx]);
      rows.push(obj);
    }
    return rows;
  }

  async function computeSarima(){
    const state = document.getElementById("mState");
    const table = document.getElementById("mTable");
    const body = document.getElementById("mBody");

    try{
      const res = await fetch("../assets/outputs/sarima/sarima_forecasts.csv", { cache: "no-store" });
      if (!res.ok) throw new Error("csv not found");
      const txt = await res.text();
      const rows = parseCSV(txt);

      const yy = [];
      const yh = [];
      for (const r of rows){
        const a = num(r.actual);
        const p = num(r.forecast);
        if (a === null || p === null) continue;
        yy.push(a); yh.push(p);
      }
      if (!yy.length) throw new Error("no rows");

      const bias = mean(yy.map((v,i)=> v - yh[i]));
      const p90 = percentile(yy, 90);

      const yp=[], yhp=[];
      for (let i=0;i<yy.length;i++){
        if (yy[i] >= p90){ yp.push(yy[i]); yhp.push(yh[i]); }
      }

      const rowsOut = [
        ["Overall MAE", fmt(mae(yy,yh))],
        ["Overall RMSE", fmt(rmse(yy,yh))],
        ["Overall MAPE (%)", fmt(mape(yy,yh))],
        ["Overall sMAPE (%)", fmt(smape(yy,yh))],
        ["Overall R²", fmt(r2(yy,yh))],
        ["Bias (mean actual − forecast)", fmt(bias)],
        ["Peak threshold (p90 of actual)", fmt(p90)],
        ["Peak MAE", fmt(mae(yp,yhp))],
        ["Peak RMSE", fmt(rmse(yp,yhp))],
        ["Peak MAPE (%)", fmt(mape(yp,yhp))],
        ["Peak sMAPE (%)", fmt(smape(yp,yhp))],
        ["Peak R²", fmt(r2(yp,yhp))],
        ["Rows", fmt(yy.length)],
        ["Peak rows", fmt(yp.length)]
      ];

      body.innerHTML = rowsOut.map(([k,v]) => `<tr><td>${k}</td><td>${v}</td></tr>`).join("");
      state.style.display = "none";
      table.style.display = "table";
    }catch(e){
      state.textContent = "Could not compute SARIMA metrics. Ensure the forecasts CSV exists in assets/outputs/sarima.";
    }
  }

  function initImageModal(){
    const modal = document.getElementById("imgModal");
    const modalImg = document.getElementById("imgModalImg");
    const modalCap = document.getElementById("imgModalCap");
    const closeBtn = document.getElementById("imgModalClose");

    function open(src, cap){
      modalImg.src = src;
      modalCap.textContent = cap || "Figure";
      modal.classList.add("open");
    }
    function close(){
      modal.classList.remove("open");
      modalImg.src = "";
    }

    document.querySelectorAll('img[data-modal="true"]').forEach((img) => {
      img.addEventListener("click", () => open(img.getAttribute("src"), img.getAttribute("data-caption")));
    });

    closeBtn.addEventListener("click", close);
    modal.addEventListener("click", (e) => { if (e.target === modal) close(); });
    document.addEventListener("keydown", (e) => { if (e.key === "Escape") close(); });
  }

  computeSarima();
  initImageModal();
</script>

<script src="../assets/app.js"></script>
</body>
</html>
